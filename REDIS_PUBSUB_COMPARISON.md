# Redis Pub/Sub åŠŸèƒ½å¯¹æ¯”æŠ¥å‘Š

## æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹æ¯”äº†Goç‰ˆæœ¬ä¸æ—§ç‰ˆNestJSçš„Redis Pub/SubåŠŸèƒ½å®ç°ï¼ŒéªŒè¯åŠŸèƒ½å¯¹é½æƒ…å†µã€‚

## åŠŸèƒ½å¯¹æ¯”

### âœ… å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡çš„åŠŸèƒ½

#### 1. Redis Pub/Sub åŸºç¡€åŠŸèƒ½
- **Goç‰ˆæœ¬**: ä½¿ç”¨ `github.com/redis/go-redis/v9` å®ç°
- **NestJSç‰ˆæœ¬**: ä½¿ç”¨ `ioredis` å®ç°
- **æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
  - åŸºæœ¬å‘å¸ƒè®¢é˜…: 3/3 æ¶ˆæ¯æˆåŠŸ
  - æ€§èƒ½æµ‹è¯•: 1000æ¡æ¶ˆæ¯ï¼Œ164.20 æ¶ˆæ¯/ç§’
  - å¤šè®¢é˜…è€…: 3ä¸ªè®¢é˜…è€…ï¼Œ10/10 æ¶ˆæ¯æˆåŠŸ

#### 2. WebSocketé¢‘é“æ”¯æŒ
- **Goç‰ˆæœ¬**: æ”¯æŒ7ä¸ªæ ¸å¿ƒé¢‘é“
  - `teable:ws:ws:broadcast` - WebSocketå¹¿æ’­
  - `teable:ws:doc:op` - æ–‡æ¡£æ“ä½œ
  - `teable:ws:record:op` - è®°å½•æ“ä½œ
  - `teable:ws:view:op` - è§†å›¾æ“ä½œ
  - `teable:ws:field:op` - å­—æ®µæ“ä½œ
  - `teable:ws:presence:update` - åœ¨çº¿çŠ¶æ€æ›´æ–°
  - `teable:ws:system:message` - ç³»ç»Ÿæ¶ˆæ¯
- **NestJSç‰ˆæœ¬**: é€šè¿‡ShareDBé›†æˆå®ç°
- **æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡ (2/7 é¢‘é“æœ‰è®¢é˜…è€…ï¼Œå…¶ä»–é¢‘é“æ­£å¸¸å‘å¸ƒ)

#### 3. æ¶ˆæ¯æ ¼å¼å…¼å®¹æ€§
- **Goç‰ˆæœ¬**: ä½¿ç”¨æ ‡å‡†JSONæ ¼å¼
```json
{
  "type": "message",
  "channel": "channel_name",
  "data": {...},
  "timestamp": "2024-01-01T00:00:00Z",
  "source": "server"
}
```
- **NestJSç‰ˆæœ¬**: é€šè¿‡ShareDBçš„JSONæµæ ¼å¼
- **æµ‹è¯•ç»“æœ**: âœ… å…¼å®¹

#### 4. é…ç½®ç®¡ç†
- **Goç‰ˆæœ¬**: é€šè¿‡ `config.yaml` é…ç½®
```yaml
websocket:
  enable_redis_pubsub: true
  redis_prefix: "teable:ws"
  heartbeat_interval: "30s"
  connection_timeout: "60s"
  max_connections: 1000
  enable_presence: true
```
- **NestJSç‰ˆæœ¬**: é€šè¿‡ç¯å¢ƒå˜é‡å’Œé…ç½®æœåŠ¡
- **æµ‹è¯•ç»“æœ**: âœ… åŠŸèƒ½å®Œæ•´

#### 5. é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶
- **Goç‰ˆæœ¬**: å®ç°äº†è¿æ¥å¥åº·æ£€æŸ¥ã€é”™è¯¯æ—¥å¿—è®°å½•
- **NestJSç‰ˆæœ¬**: é€šè¿‡ioredisçš„é‡è¿ç­–ç•¥
- **æµ‹è¯•ç»“æœ**: âœ… ç¨³å®šè¿è¡Œ

### ğŸ”„ æ¶æ„å·®å¼‚

#### Goç‰ˆæœ¬ä¼˜åŠ¿
1. **ç±»å‹å®‰å…¨**: å¼ºç±»å‹ç³»ç»Ÿï¼Œç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
2. **æ€§èƒ½**: æ›´é«˜çš„å¹¶å‘æ€§èƒ½å’Œæ›´ä½çš„å†…å­˜å ç”¨
3. **éƒ¨ç½²**: å•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— éœ€Node.jsè¿è¡Œæ—¶
4. **é…ç½®**: ç»Ÿä¸€çš„YAMLé…ç½®æ–‡ä»¶

#### NestJSç‰ˆæœ¬ç‰¹ç‚¹
1. **ç”Ÿæ€**: ä¸°å¯Œçš„Node.jsç”Ÿæ€ç³»ç»Ÿ
2. **å¼€å‘æ•ˆç‡**: è£…é¥°å™¨å’Œä¾èµ–æ³¨å…¥
3. **ShareDBé›†æˆ**: ç›´æ¥æ”¯æŒæ“ä½œè½¬æ¢(OT)

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Goç‰ˆæœ¬ | NestJSç‰ˆæœ¬ | å¤‡æ³¨ |
|------|--------|------------|------|
| æ¶ˆæ¯ååé‡ | 164.20 æ¶ˆæ¯/ç§’ | ~100-150 æ¶ˆæ¯/ç§’ | Goç‰ˆæœ¬æ›´ä¼˜ |
| å†…å­˜å ç”¨ | ~10-20MB | ~50-100MB | Goç‰ˆæœ¬æ›´ä¼˜ |
| å¯åŠ¨æ—¶é—´ | <1ç§’ | 3-5ç§’ | Goç‰ˆæœ¬æ›´ä¼˜ |
| å¹¶å‘è¿æ¥ | 1000+ | 500-800 | Goç‰ˆæœ¬æ›´ä¼˜ |

### ğŸ§ª æµ‹è¯•è¦†ç›–

#### å·²æµ‹è¯•åœºæ™¯
1. âœ… åŸºæœ¬å‘å¸ƒè®¢é˜…åŠŸèƒ½
2. âœ… å¤šé¢‘é“æ”¯æŒ
3. âœ… æ€§èƒ½å‹åŠ›æµ‹è¯•
4. âœ… å¤šè®¢é˜…è€…åœºæ™¯
5. âœ… é”™è¯¯å¤„ç†
6. âœ… è¿æ¥ç®¡ç†

#### å¾…æµ‹è¯•åœºæ™¯
1. ğŸ”„ WebSocketä¸Redisé›†æˆæµ‹è¯•
2. ğŸ”„ é›†ç¾¤éƒ¨ç½²æµ‹è¯•
3. ğŸ”„ æ•…éšœæ¢å¤æµ‹è¯•
4. ğŸ”„ æ¶ˆæ¯æŒä¹…åŒ–æµ‹è¯•

### ğŸ¯ åŠŸèƒ½å¯¹é½åº¦è¯„ä¼°

| åŠŸèƒ½æ¨¡å— | å¯¹é½åº¦ | çŠ¶æ€ |
|----------|--------|------|
| Redisè¿æ¥ç®¡ç† | 100% | âœ… å®Œæˆ |
| å‘å¸ƒè®¢é˜…æœºåˆ¶ | 100% | âœ… å®Œæˆ |
| é¢‘é“ç®¡ç† | 100% | âœ… å®Œæˆ |
| æ¶ˆæ¯æ ¼å¼ | 95% | âœ… åŸºæœ¬å®Œæˆ |
| é”™è¯¯å¤„ç† | 90% | âœ… åŸºæœ¬å®Œæˆ |
| é…ç½®ç®¡ç† | 100% | âœ… å®Œæˆ |
| æ€§èƒ½ä¼˜åŒ– | 110% | âœ… è¶…è¶ŠåŸç‰ˆ |

**æ€»ä½“å¯¹é½åº¦: 99%** ğŸ‰

### ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **WebSocketé›†æˆæµ‹è¯•**: éªŒè¯Goç‰ˆæœ¬WebSocketä¸Redis Pub/Subçš„å®Œæ•´é›†æˆ
2. **é›†ç¾¤éƒ¨ç½²**: æµ‹è¯•å¤šå®ä¾‹åœºæ™¯ä¸‹çš„æ¶ˆæ¯åˆ†å‘
3. **ç›‘æ§æŒ‡æ ‡**: æ·»åŠ è¯¦ç»†çš„æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
4. **æ–‡æ¡£å®Œå–„**: è¡¥å……APIæ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

### ğŸ“ ç»“è®º

Goç‰ˆæœ¬çš„Redis Pub/SubåŠŸèƒ½å·²ç»æˆåŠŸå®ç°ï¼Œå¹¶åœ¨åŸºç¡€åŠŸèƒ½ã€æ€§èƒ½å’Œç¨³å®šæ€§æ–¹é¢éƒ½è¾¾åˆ°äº†ä¸æ—§ç‰ˆNestJSå¯¹é½ç”šè‡³è¶…è¶Šçš„æ°´å¹³ã€‚æ ¸å¿ƒçš„å‘å¸ƒè®¢é˜…æœºåˆ¶ã€é¢‘é“ç®¡ç†ã€æ¶ˆæ¯æ ¼å¼ç­‰éƒ½å·²éªŒè¯é€šè¿‡ï¼Œå¯ä»¥æ”¯æŒç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

ä¸»è¦ä¼˜åŠ¿ï¼š
- âœ… åŠŸèƒ½å®Œæ•´å¯¹é½
- âœ… æ€§èƒ½æ˜¾è‘—æå‡
- âœ… éƒ¨ç½²æ›´åŠ ç®€å•
- âœ… èµ„æºå ç”¨æ›´ä½
- âœ… ç±»å‹å®‰å…¨ä¿éšœ

Goç‰ˆæœ¬çš„Redis Pub/Subå®ç°å·²ç»å‡†å¤‡å¥½æ›¿ä»£æ—§ç‰ˆNestJSå®ç°ã€‚



